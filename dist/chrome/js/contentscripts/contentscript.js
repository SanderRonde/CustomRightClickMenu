"use strict";var __awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;g;)try{if(e=1,f&&(h=2&c[0]?f["return"]:c[0]?f["throw"]||((h=f["return"])&&h.call(f),0):f.next)&&!(h=h.call(f,c[1])).done)return h;switch((f=0,h)&&(c=[2&c[0],h.value]),c[0]){case 0:case 1:h=c;break;case 4:return g.label++,{value:c[1],done:!1};case 5:g.label++,f=c[1],c=[0];continue;case 7:c=g.ops.pop(),g.trys.pop();continue;default:if((h=g.trys,!(h=0<h.length&&h[h.length-1]))&&(6===c[0]||2===c[0])){g=0;continue}if(3===c[0]&&(!h||c[1]>h[0]&&c[1]<h[3])){g.label=c[1];break}if(6===c[0]&&g.label<h[1]){g.label=h[1],h=c;break}if(h&&g.label<h[2]){g.label=h[2],g.ops.push(c);break}h[2]&&g.ops.pop(),g.trys.pop();continue;}c=b.call(a,g)}catch(a){c=[6,a],f=0}finally{e=h=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,f,h,i,g={label:0,sent:function(){if(1&h[0])throw h[1];return h[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"===typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i};(function(){function a(a){var b=document.createElement("script");b.innerHTML=a,document.documentElement.appendChild(b),document.documentElement.removeChild(b)}function b(a){return new Promise(function(b){var c=new XMLHttpRequest;c.open("GET",a),c.onreadystatechange=function(){4===c.readyState&&(200===c.status?b(c.responseText):console.warn("Failed to run script because the CRM API could not be found"))},c.send()})}function c(){return __awaiter(this,void 0,void 0,function(){var c,d;return __generator(this,function(e){switch(e.label){case 0:return c=browserAPI.runtime.getURL("/js/crmapi.js"),[4,b(c)];case 1:return d=e.sent(),a(d),[2];}})})}function d(c,e){return void 0===e&&(e=0),__awaiter(this,void 0,void 0,function(){var f,g;return __generator(this,function(h){switch(h.label){case 0:return c.length>e?c[e].code?(a(c[e].code),[4,d(c,e+1)]):[3,2]:[3,5];case 1:return h.sent(),[3,5];case 2:return f=c[e].file,0!==f.indexOf("http")&&(f=browserAPI.runtime.getURL(f)),[4,b(f)];case 3:return g=h.sent(),a(g),[4,d(c,e+1)];case 4:h.sent(),h.label=5;case 5:return[2];}})})}var e=["clientX","clientY","offsetX","offsetY","pageX","pageY","screenX","screenY","which","x","y"],f=!1,g=1,h=!1,i=null;browserAPI.runtime.onMessage.addListener(function(a,b,j){var k=this;switch(a.type){case"checkTabStatus":j({notMatchedYet:!f}),a.data.willBeMatched&&(f=!0);break;case"getLastClickInfo":var l={};for(var m in i)if(-1!==e.indexOf(m)){var n=m;"button"!==n&&(l[n]=i[n])}null===i?j(null):(i.srcElement&&i.srcElement.classList.add("crm_element_identifier_"+ ++g),l.srcElement=g,i.target.classList.add("crm_element_identifier_"+ ++g),l.target=g,i.toElement.classList.add("crm_element_identifier_"+ ++g),l.toElement=g,j(l));break;case"runScript":h?d(a.data.scripts):function(){return __awaiter(k,void 0,void 0,function(){return __generator(this,function(b){switch(b.label){case 0:return[4,c()];case 1:return b.sent(),d(a.data.scripts),h=!0,[2];}})})}();}}),browserAPI.runtime.sendMessage({type:"newTabCreated"}).then(function(a){a&&a.matched&&(f=!0)}),browserAPI.storage.local.get().then(function(a){if(a.useAsUserscriptInstaller){var b=browserAPI.runtime.getURL("html/install.html");document.body.addEventListener("mousedown",function(c){var d=c.target,e=d&&d.href&&-1===d.href.indexOf(b);if(e&&a.useAsUserscriptInstaller&&d.href.match(/.+user\.js$/)){var f=b+"?i="+encodeURIComponent(d.href)+"&s="+encodeURIComponent(location.href);d.href=f,d.target="_blank"}})}}),document.addEventListener("contextmenu",function(a){i=a})})();